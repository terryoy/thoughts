---
layout: post
title: JavaScript加载的优化策略
date: 2020-03-17 14:48
tag: frontend
---

在前端性能优化的工作中，我们一直在尝试优化前端的静态资源加载速度，包括：JavaScript、CSS、图片资源等。

### 总体策略

为了让首屏加载时间尽可能小，在打开页面的时候尽可能减少必要的静态资源加载，而且采用激进的缓存机制，同时采用CDN加快到远端的下载速度，所以总体策略包括如下：

* 按模块拆包。把JavaScript按模块拆成若干个文件的好处有两点：
  * 可以复用链接并行下载内容
  * 如果文件没有改动，可以使用浏览器缓存，从而减少下载时间。
* 按需加载。没用到的功能，先不要加载；首屏打开时只加载核心内容，其他功能逐步加载。
  * 好处是会大大减少打开首屏要加载的脚本大小
* 页面缓存。静态资源采用缓存的话，可以减少下载的速度
* CDN，加速不同地区的下载速度。

这里分别讲讲几种策略里的一些实践。

### 按需加载

#### 1. script标签的async, defer关键字

本质上这些关键字是为了让JS脚本**文件**的加载不阻塞浏览器渲染的主流程，告诉浏览器，加载这些JS不要影响页面内容解析和渲染。

* `defer`, 表明脚本在执行时不会影响页面的构造，因此会被延迟到整个页面都解析完毕后再运行。
* `async`, 与defer类似，但defer是顺序执行的，而async是乱序执行的。因此async适合用于一些可有可无的统计脚本。
* 如果不使用上述两种关键字，希望页面打开的时候就要加载这些JS，也应该尽量放在HTML内容的末尾。这样可以保证浏览器先显示出来之前的内容，在加载脚本的时候，已经有可看的内容。

注意这些关键字并不会影响script里面包含的脚本内容，只跟脚本文件的加载有关。

另外还有一种加载脚本的方式是脚本创建的，它的默认行为是async为True。

```
let script = document.createElement('script');
script.src = "/scripts/some_scripts.js";
document.body.append(script); // 实际是script.async == true
```



#### 2. 通过webpack的lazy-loading插件

